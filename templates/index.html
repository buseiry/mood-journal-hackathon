<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mood Lab â€” Fast UI</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#7c3aed">

  <style>
    :root{--bg:#071028;--card:#fff;--accent1:#7c3aed;--accent2:#06b6d4;--muted:#64748b;--radius:14px}
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,system-ui; background:linear-gradient(135deg,#071028,#081124); color:#071028}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px}
    .app{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 420px;gap:22px}
    @media(max-width:980px){.app{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.94));padding:22px;border-radius:var(--radius);box-shadow:0 12px 40px rgba(2,6,23,0.55)}
    header.app-head{display:flex;gap:16px;align-items:center;margin-bottom:14px}
    .logo{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;font-size:22px}
    h1{font-size:20px;margin:0;font-weight:700} p.lead{margin:0;color:var(--muted);font-size:13px}
    textarea#entry{width:100%;min-height:160px;padding:14px;margin-top:12px;border-radius:12px;border:1px solid rgba(11,18,32,0.06);font-size:15px}
    textarea:focus{outline:none;box-shadow:0 6px 30px rgba(17,24,39,0.06);border-color:rgba(124,58,237,0.3)}
    .actions{display:flex;gap:12px;align-items:center;margin-top:14px}
    button.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;border:0;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);padding:10px 14px;border-radius:999px;color:var(--muted);cursor:pointer}
    .status-row{display:flex;gap:12px;align-items:center;margin-top:16px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.06);font-size:13px;color:var(--muted)}
    .result{margin-top:18px;display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .big-emotion{min-width:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#f7fbff);padding:14px;border-radius:12px}
    .big-emoji{font-size:42px} .big-label{font-weight:700;font-size:16px}
    .score-bar{width:140px;height:10px;border-radius:8px;background:#eef2ff;overflow:hidden}
    .score-fill{height:100%;border-radius:8px;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;font-size:13px;background:#fff;border:1px solid rgba(11,18,32,0.04)}
    .right{display:flex;flex-direction:column;gap:18px}
    .panel{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .history-list{display:flex;flex-direction:column;gap:10px;max-height:300px;overflow:auto}
    .entry{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(11,18,32,0.03)}
    .entry .text{font-size:13px;color:#071028;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .entry .time{font-size:12px;color:var(--muted)}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(10,14,20,0.92);color:white;padding:12px 18px;border-radius:12px;font-weight:600;display:none;z-index:40}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <div class="card">
        <header class="app-head">
          <div class="logo"><i class="fa-solid fa-face-smile"></i></div>
          <div>
            <h1>Mood Lab</h1>
            <p class="lead">Fast, clear emotion analysis. Works with your backend.</p>
          </div>
        </header>

        <label for="entry" class="muted">Write a short journal entry or a line of text</label>
        <textarea id="entry" placeholder="Type how you feel... Example: 'I got a promotion and I feel excited'"></textarea>

        <div class="actions">
          <button class="primary" id="btnAnalyze"><i class="fa-solid fa-bolt"></i>&nbsp;Analyze</button>
          <button class="ghost" id="btnClear"><i class="fa-solid fa-eraser"></i>&nbsp;Clear</button>
          <div style="flex:1"></div>
          <div class="pill" id="countPill">Entries: â€”</div>
        </div>

        <div class="status-row" id="statusRow" style="display:none">
          <div class="pill" id="lastAnalyzed">Last: â€”</div>
          <div class="pill" id="confidencePill">Confidence: â€”</div>
        </div>

        <div class="result" id="resultArea" style="display:none">
          <div class="big-emotion" aria-live="polite">
            <div class="big-emoji" id="resEmoji">ðŸ™‚</div>
            <div class="big-label" id="resLabel">Neutral</div>
            <div class="score-bar"><div class="score-fill" id="resFill"></div></div>
          </div>

          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted">Detected emotions</div>
              <div class="muted" id="rawLabelCount">â€”</div>
            </div>
            <div class="chips" id="chips"></div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="panel">
          <h3>Recent history</h3>
          <div class="history-list" id="historyList" aria-live="polite"></div>
        </div>

        <div class="panel">
          <h3>Mood trend</h3>
          <div style="margin-top:8px"><canvas id="trendChart" width="400" height="160"></canvas></div>
          <div style="height:12px"></div>
          <h3 style="margin-top:6px">Frequency</h3>
          <div style="margin-top:8px"><canvas id="freqChart" width="400" height="120"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API = { analyze: '/analyze', history: '/history' };

    const CANON = { joy:'joy', happy:'joy', excited:'joy', surprise:'surprise', neutral:'neutral', sad:'sadness', sadness:'sadness', angry:'anger', anger:'anger', disgust:'disgust', fear:'fear' };
    const EMOTIONS = ['anger','disgust','fear','sadness','neutral','surprise','joy'];
    const EMO_META = {
      anger:   {name:'Anger', emoji:'ðŸ˜¡', color:'#ff6b6b'},
      disgust: {name:'Disgust', emoji:'ðŸ¤¢', color:'#8bc34a'},
      fear:    {name:'Fear', emoji:'ðŸ˜¨', color:'#ff9f1c'},
      sadness: {name:'Sad', emoji:'ðŸ˜¢', color:'#3b82f6'},
      neutral: {name:'Neutral', emoji:'ðŸ˜', color:'#94a3b8'},
      surprise:{name:'Surprise', emoji:'ðŸ˜²', color:'#a78bfa'},
      joy:     {name:'Joy', emoji:'ðŸ˜„', color:'#f6c94c'}
    };
    const VALUE_OF = EMOTIONS.reduce((a,k,i)=> (a[k]=i,a), {});

    const entryEl = document.getElementById('entry');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const btnClear = document.getElementById('btnClear');
    const toastEl = document.getElementById('toast');
    const resultArea = document.getElementById('resultArea');
    const resEmoji = document.getElementById('resEmoji');
    const resLabel = document.getElementById('resLabel');
    const resFill = document.getElementById('resFill');
    const chips = document.getElementById('chips');
    const historyList = document.getElementById('historyList');
    const countPill = document.getElementById('countPill');
    const lastAnalyzed = document.getElementById('lastAnalyzed');
    const confidencePill = document.getElementById('confidencePill');
    const rawLabelCount = document.getElementById('rawLabelCount');

    let trendChart=null, freqChart=null;

    function showToast(msg, t=2500){ toastEl.textContent=msg; toastEl.style.display='block'; clearTimeout(window._t); window._t=setTimeout(()=>toastEl.style.display='none', t); }

    function canon(label){ if(!label) return 'neutral'; const k=String(label).toLowerCase().trim(); return CANON[k] || k; }
    async function safeJSON(res){ return res.json().catch(()=>({error:'invalid json'})); }

    function renderResult(data){
      if(!data || !data.emotion) return;
      const raw = data.emotion; const label = canon(raw); const score = Number(data.score||0)/100;
      const meta = EMO_META[label]||{name:label,emoji:'ðŸ™‚',color:'#94a3b8'};
      resultArea.style.display='flex';
      resEmoji.textContent=meta.emoji;
      resLabel.textContent=meta.name;
      resFill.style.width = Math.max(6, Math.min(100, Math.round(score*100))) + '%';
      resFill.style.background = meta.color;
      lastAnalyzed.textContent = 'Last: ' + new Date().toLocaleString();
      confidencePill.textContent = 'Confidence: ' + Math.round(score*100) + '%';
      chips.innerHTML='';
      const list = Array.isArray(data.all_emotions) ? data.all_emotions : [];
      rawLabelCount.textContent = list.length ? list.length : 'â€”';
      list.forEach(e=>{
        const lab = canon(e.label||''); const m = EMO_META[lab]||{name:lab,emoji:'ðŸ™‚',color:'#ddd'};
        const chip = document.createElement('div'); chip.className='chip';
        chip.innerHTML = `<span style="font-size:16px">${m.emoji}</span><span style="font-weight:600">${m.name}</span><span style="opacity:0.65;margin-left:8px">${Math.round((e.score||0)*100)}%</span>`;
        chips.appendChild(chip);
      });
    }

    function buildTrendChart(labels, values){
      const ctx = document.getElementById('trendChart').getContext('2d');
      if(trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type:'line', data:{labels, datasets:[{label:'Mood over time', data:values, borderColor:'rgba(124,58,237,0.9)', backgroundColor:'rgba(124,58,237,0.12)', fill:true, tension:0.32, pointRadius:4}]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:true,maxTicksLimit:8}}, y:{min:0,max:EMOTIONS.length-1,ticks:{stepSize:1,callback:v=>EMO_META[EMOTIONS[v]]?EMO_META[EMOTIONS[v]].name:v}}}}
      });
    }

    function buildFreqChart(labels, dataVals, colors){
      const ctx = document.getElementById('freqChart').getContext('2d');
      if(freqChart) freqChart.destroy();
      freqChart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'Frequency', data:dataVals, backgroundColor:colors, borderRadius:8}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});
    }

    async function loadHistory(){
      try{
        const res = await fetch(API.history);
        const payload = await safeJSON(res);
        if(payload && payload.error){ showToast('History load error'); return; }
        const entries = Array.isArray(payload) ? payload : [];
        countPill.textContent = 'Entries: ' + entries.length;
        historyList.innerHTML = '';
        const chrono = entries.slice().sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
        chrono.slice().reverse().forEach(e=>{
          const left = document.createElement('div'); left.className='left';
          const txt = document.createElement('div'); txt.className='text'; txt.textContent = e.text||'';
          const time = document.createElement('div'); time.className='time'; time.textContent = e.created_at ? new Date(e.created_at).toLocaleString() : '';
          left.appendChild(txt);
          const canonLab = canon(e.emotion || e.emotion_label || '');
          const meta = EMO_META[canonLab] || {name:canonLab,color:'#94a3b8',emoji:'ðŸ™‚'};
          const badge = document.createElement('div'); badge.className='badge'; badge.style.background = meta.color; badge.style.color='#fff'; badge.textContent = meta.emoji + ' ' + meta.name;
          const item = document.createElement('div'); item.className='entry'; item.appendChild(left);
          const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
          right.appendChild(time); right.appendChild(badge); item.appendChild(right);
          historyList.appendChild(item);
        });

        const times = chrono.map(e => e.created_at ? new Date(e.created_at).toLocaleString() : new Date().toLocaleString());
        const values = chrono.map(e => { const lab = canon(e.emotion||e.emotion_label||''); return VALUE_OF[lab] !== undefined ? VALUE_OF[lab] : VALUE_OF['neutral']; });
        const freq = EMOTIONS.map(k => chrono.reduce((s,e)=> s + (canon(e.emotion||e.emotion_label||'')===k ? 1 : 0), 0));
        const labels = EMOTIONS.map(k => EMO_META[k] ? EMO_META[k].name : k);
        const colors = EMOTIONS.map(k => EMO_META[k] ? EMO_META[k].color : '#94a3b8');
        if(times.length) buildTrendChart(times, values); else buildTrendChart(['â€”'], [VALUE_OF['neutral']]);
        buildFreqChart(labels, freq, colors);
      }catch(err){ console.error('loadHistory', err); showToast('Failed to load history'); }
    }

    async function analyzeText(){
      const text = entryEl.value.trim();
      if(!text){ showToast('Enter some text'); entryEl.focus(); return; }
      btnAnalyze.disabled = true; btnAnalyze.textContent = 'Analyzing...';
      try{
        if(!navigator.onLine){
          queueOfflineAnalysis(text); showToast('Saved locally. Will sync when online.'); entryEl.value=''; await loadHistory(); return;
        }
        const r = await fetch(API.analyze, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text }) });
        const data = await safeJSON(r);
        if(data && data.error){ showToast(data.error || 'Analysis failed'); return; }
        renderResult(data); showToast('Analysis recorded'); entryEl.value=''; await loadHistory();
      }catch(err){ console.error('analyzeText', err); showToast('Server error'); }
      finally{ btnAnalyze.disabled=false; btnAnalyze.innerHTML='<i class="fa-solid fa-bolt"></i>&nbsp;Analyze'; }
    }

    btnAnalyze.addEventListener('click', analyzeText);
    btnClear.addEventListener('click', ()=>{ entryEl.value=''; entryEl.focus(); });
    window.addEventListener('load', ()=>{ flushQueue().then(()=> loadHistory()); });

    // PWA offline queue helpers (localStorage)
    const QUEUE_KEY = 'moodlab-offline-queue';
    function queueOfflineAnalysis(text){ const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); q.push({ id:Date.now()+'-'+Math.random().toString(36).slice(2,8), text, ts:new Date().toISOString() }); localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
    async function flushQueue(){
      if(!navigator.onLine) return;
      const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
      if(!q.length) return;
      for(const item of q.slice()){
        try{
          const resp = await fetch(API.analyze, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: item.text }) });
          const json = await safeJSON(resp);
          if(!json.error){
            const newQ = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]').filter(x=> x.id !== item.id);
            localStorage.setItem(QUEUE_KEY, JSON.stringify(newQ));
          }
        }catch(e){ console.warn('flushQueue fail', e); break; }
      }
    }
    window.addEventListener('online', ()=>{ flushQueue().then(()=> loadHistory()); showToast('Back online. Syncing queued entries.'); });

    // register service worker
    if('serviceWorker' in navigator){
      window.addEventListener('load', async ()=> {
        try{ await navigator.serviceWorker.register('/sw.js'); console.log('SW registered'); }
        catch(err){ console.warn('SW failed', err); }
      });
    }
  </script>
</body>
</html>
